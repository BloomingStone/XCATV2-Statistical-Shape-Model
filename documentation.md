# generate_heartbeat_ssm

**Usage**:

```console
$ python main.py [OPTIONS] COMMAND [ARGS]...
```

**Options**:

* `--help`: Show this message and exit.

**Commands**:

* `generate-ssm-data`: Generate beat-to-beat moving heart NII...
* `get-surface-cloud`: Generate surface cloud of cavity from SSM...
* `get-volume-cloud`: Generate volume cloud of cavity from SSM...
* `align-surface`: Align surface and deform template surface...
* `calculate-ssm`: Calculate the Statistical Shape Model...

## `python main.py generate-ssm-data`

Generate beat-to-beat moving heart NII images and corresponding labels for different patient models to provide data for the subsequent calculation of shape statistical models (SSM). It may take several hours. [STEP 1]

**Usage**:

```console
$ python main.py generate-ssm-data [OPTIONS] [OUTPUT_DIR]
```

**Arguments**:

* `[OUTPUT_DIR]`: The output directory. Temporary folders will be created to store the original data generated by XCAT, and the final result will be saved in nii format.  [default: <project_root>/data/output_ssm_nii]

**Options**:

* `--xcat-dir PATH`: The directory where XCAT is located.  [env var: XCAT_HOME; default: <project_root>/XCAT]
* `--xcat-adult-nrb-files PATH`: The directory where the patient nrb model files need by XCAT are located.  [env var: XCAT_ADULT_NRB_FILES; default: <project_root>/xcat_adult_nrb_files]
* `--parameter-file PATH`: The parameter file for XCAT.  [default: <project_root>/parameters/statistical_shape_model_base.par]
* `--out-frames INTEGER`: Total phase number of heart to produce.  [default: 20]
* `--include-vessels / --no-include-vessels`: Whether to include vessels(coronary art, coronary vein, papillary) in the output.  [default: no-include-vessels]
* `--num-workers INTEGER`: The number of multiprocessing to use. default is half of the number of CPU cores.  [default: 16]
* `--help`: Show this message and exit.

## `python main.py get-surface-cloud`

Generate surface cloud of cavity from SSM NII files. [STEP 2]

**Usage**:

```console
$ python main.py get-surface-cloud [OPTIONS] [SSM_NII_DIR] [SURFACE_VTK_DIR]
```

**Arguments**:

* `[SSM_NII_DIR]`: The directory containing the SSM NII files generated by `generate_ssm_data`.  [default: <project_root>/data/output_ssm_nii]
* `[SURFACE_VTK_DIR]`: The output directory to save the surface cloud VTK files.  [default: <project_root>/data/output_ssm_vtk_surface]

**Options**:

* `--max-point-num INTEGER`: The maximum number of points in the surface cloud.  [default: 500]
* `--num-workers INTEGER`: The number of multiprocessing to use. default is half of the number of CPU cores.  [default: 16]
* `--help`: Show this message and exit.

## `python main.py get-volume-cloud`

Generate volume cloud of cavity from SSM NII files.[STEP 3]

**Usage**:

```console
$ python main.py get-volume-cloud [OPTIONS] [SSM_NII_DIR] [VOLUME_VTK_DIR]
```

**Arguments**:

* `[SSM_NII_DIR]`: The directory containing the SSM NII files generated by generate_ssm_data.  [default: <project_root>/data/output_ssm_nii]
* `[VOLUME_VTK_DIR]`: The output directory to save the volume cloud VTK files.  [default: <project_root>/data/output_ssm_vtk_volume]

**Options**:

* `--max-point-num INTEGER`: The maximum number of points in the volume cloud.  [default: 1000]
* `--num-workers INTEGER`: The number of multiprocessing to use. default is half of the number of CPU cores.  [default: 16]
* `--help`: Show this message and exit.

## `python main.py align-surface`

Align surface and deform template surface to fit aliged surface [STEP 4]
1) align surface by the transformation of the volume point cloud (moving volume point cloud -&gt; fixed volume point cloud choosen by the first case)
2) deform template surface to the aligned surface

**Usage**:

```console
$ python main.py align-surface [OPTIONS] [SURFACE_VTK_DIR] [VOLUME_POINTS_CLOUD_DIR] [ALIGNED_VTK_DIR] [TEMPLATE_SURFACE_PATH] [NUM_GPUS]
```

**Arguments**:

* `[SURFACE_VTK_DIR]`: Surface vtk files dir generated by `get_surface_vtk`  [default: <project_root>/data/output_ssm_vtk_surface]
* `[VOLUME_POINTS_CLOUD_DIR]`: Volume points cloud vtk files dir generated by `get_volume_points_cloud`  [default: <project_root>/data/output_ssm_vtk_volume]
* `[ALIGNED_VTK_DIR]`: Output aligned surface vtk files dir  [default: <project_root>/data/output_ssm_vtk_aligned]
* `[TEMPLATE_SURFACE_PATH]`: Template surface vtk file. If not provided, use the first surface as template
* `[NUM_GPUS]`: Number of GPUs to use for processing  [default: 4]

**Options**:

* `--help`: Show this message and exit.

## `python main.py calculate-ssm`

Calculate the Statistical Shape Model (SSM) for the aligned VTK files. [STEP 2]
1) Calculate the mean points per patient, per phase, and globally.
2) Calculate the anatomy PCA and motion PCA.

**Usage**:

```console
$ python main.py calculate-ssm [OPTIONS] [ALIGNED_VTK_DIR] [OUTPUT_DIR]
```

**Arguments**:

* `[ALIGNED_VTK_DIR]`: The directory containing the aligned VTK files.  [default: <project_root>/data/output_ssm_vtk_aligned]
* `[OUTPUT_DIR]`: The output directory for the Statistical Shape Model (SSM) results.  [default: <project_root>/data/output_ssm_pca]

**Options**:

* `--template-surface PATH`: The template surface for the SSM, used to generate the new average surface template  [default: <project_root>/ssm_template.vtk]
* `--visualize / --no-visualize`: Whether to visualize the motion deformation.  [default: no-visualize]
* `--help`: Show this message and exit.
